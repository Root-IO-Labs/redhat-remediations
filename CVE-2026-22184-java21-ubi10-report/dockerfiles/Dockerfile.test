# CVE-2026-22184 Test Container
# Tests Java 21 OpenJDK for zlib untgz buffer overflow vulnerability
#
# Usage:
#   docker build -f Dockerfile.test -t cve-2026-22184-test .
#   docker run --rm cve-2026-22184-test
#

FROM registry.access.redhat.com/ubi10/ubi

LABEL description="CVE-2026-22184 Vulnerability Test Container"
LABEL cve="CVE-2026-22184"
LABEL tested_package="java-21-openjdk"

# Install Java and development tools
RUN dnf -y update && \
    dnf -y install \
        java-21-openjdk-devel \
        gcc \
        file \
        binutils && \
    dnf clean all

# Create test directory
WORKDIR /test

# Copy PoC files
COPY poc/java/*.java /test/java/
COPY poc/c/*.c /test/c/

# Compile Java tests (use UTF-8 encoding for Unicode characters in source)
RUN cd /test/java && \
    javac -encoding UTF-8 ComprehensiveZlibTest.java && \
    javac -encoding UTF-8 TestBufferOverflow.java

# Compile C vulnerability demo (with stack protector disabled to show vulnerability)
RUN cd /test/c && \
    gcc -fno-stack-protector -o vulnerable_demo vulnerable_untgz_demo.c

# Create run script
RUN echo '#!/bin/bash' > /test/run-all.sh && \
    echo 'echo "╔═══════════════════════════════════════════════════════════════════════════════╗"' >> /test/run-all.sh && \
    echo 'echo "║     CVE-2026-22184 Vulnerability Test Suite                                   ║"' >> /test/run-all.sh && \
    echo 'echo "╚═══════════════════════════════════════════════════════════════════════════════╝"' >> /test/run-all.sh && \
    echo 'echo ""' >> /test/run-all.sh && \
    echo 'echo "Java version:"' >> /test/run-all.sh && \
    echo 'java -version 2>&1' >> /test/run-all.sh && \
    echo 'echo ""' >> /test/run-all.sh && \
    echo 'echo "════════════════════════════════════════════════════════════════════════════════"' >> /test/run-all.sh && \
    echo 'echo "Running Java comprehensive test..."' >> /test/run-all.sh && \
    echo 'echo "════════════════════════════════════════════════════════════════════════════════"' >> /test/run-all.sh && \
    echo 'cd /test/java && java ComprehensiveZlibTest' >> /test/run-all.sh && \
    echo 'JAVA_RESULT=$?' >> /test/run-all.sh && \
    echo 'echo ""' >> /test/run-all.sh && \
    echo 'echo "════════════════════════════════════════════════════════════════════════════════"' >> /test/run-all.sh && \
    echo 'echo "Running C vulnerability demo (may crash - this demonstrates the bug)..."' >> /test/run-all.sh && \
    echo 'echo "════════════════════════════════════════════════════════════════════════════════"' >> /test/run-all.sh && \
    echo 'cd /test/c && timeout 10 ./vulnerable_demo || echo "C demo completed (crash expected for large inputs)"' >> /test/run-all.sh && \
    echo 'echo ""' >> /test/run-all.sh && \
    echo 'exit $JAVA_RESULT' >> /test/run-all.sh && \
    chmod +x /test/run-all.sh

# Default command
CMD ["/test/run-all.sh"]
