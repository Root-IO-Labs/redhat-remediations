#!/bin/bash
#
# CVE-2026-22184 Source Code Verification
# Verifies that the vulnerable untgz code is NOT present in Java 17 source
#
# Usage: ./verify-source.sh [path-to-srpm]
#

set -e

SRPM_PATH="${1:-/home/vishnu-prasad/workspace/rootio/github-repos/redhat-remediations/srpm/java-17-openjdk-17.0.17.0.10-1.el9.src.rpm}"

echo "╔═══════════════════════════════════════════════════════════════════════════════╗"
echo "║     CVE-2026-22184 Source Code Verification                                   ║"
echo "║     Verifying vulnerable code is NOT present in Java 17 source                 ║"
echo "╚═══════════════════════════════════════════════════════════════════════════════╝"
echo ""

if [ ! -f "$SRPM_PATH" ]; then
    echo "ERROR: SRPM not found at: $SRPM_PATH"
    echo "Usage: $0 [path-to-srpm]"
    exit 1
fi

echo "SRPM: $SRPM_PATH"
echo ""

docker run --rm \
    -v "$SRPM_PATH:/srpm/java.src.rpm:ro" \
    registry.access.redhat.com/ubi9/ubi \
    bash -c '
dnf -y install cpio xz findutils grep >/dev/null 2>&1

echo "════════════════════════════════════════════════════════════════════════════════"
echo "  Extracting SRPM..."
echo "════════════════════════════════════════════════════════════════════════════════"
cd /tmp
rpm2cpio /srpm/java.src.rpm | cpio -idm 2>/dev/null

TARBALL=$(ls openjdk*.tar.xz jdk*.tar.xz openjdk*.tar.gz jdk*.tar.gz 2>/dev/null | head -1)
echo "Tarball: $TARBALL"
if [[ "$TARBALL" == *.xz ]]; then
    tar -xf "$TARBALL"
elif [[ "$TARBALL" == *.gz ]]; then
    tar -xzf "$TARBALL"
else
    echo "ERROR: Unknown tarball format"
    exit 1
fi

SRCDIR=$(ls -d jdk-* openjdk-* 2>/dev/null | head -1)
echo "Source: $SRCDIR"
echo ""

echo "════════════════════════════════════════════════════════════════════════════════"
echo "  Verification Checks"
echo "════════════════════════════════════════════════════════════════════════════════"
echo ""

PASS=0
FAIL=0

echo -n "1. untgz.c (vulnerable file).......... "
if find "$SRCDIR" -name "untgz.c" 2>/dev/null | grep -q .; then
    echo "❌ FOUND"; ((FAIL++))
else
    echo "✅ NOT FOUND"; ((PASS++))
fi

echo -n "2. TGZfname (vulnerable function)..... "
if grep -rq "TGZfname" "$SRCDIR" 2>/dev/null; then
    echo "❌ FOUND"; ((FAIL++))
else
    echo "✅ NOT FOUND"; ((PASS++))
fi

echo -n "3. contrib/ directory................. "
if find "$SRCDIR" -type d -name "contrib" 2>/dev/null | grep -q .; then
    echo "❌ FOUND"; ((FAIL++))
else
    echo "✅ NOT FOUND"; ((PASS++))
fi

echo -n "4. fname[1024] (vulnerable buffer).... "
if grep -rq "fname\[1024\]" "$SRCDIR" 2>/dev/null; then
    echo "❌ FOUND"; ((FAIL++))
else
    echo "✅ NOT FOUND"; ((PASS++))
fi

echo ""
echo "════════════════════════════════════════════════════════════════════════════════"
echo "  Java zlib Bundle"
echo "════════════════════════════════════════════════════════════════════════════════"
ZLIB=$(find "$SRCDIR" -type d -path "*libzip/zlib" 2>/dev/null | head -1)
if [ -n "$ZLIB" ]; then
    echo "Location: $ZLIB"
    echo "Files:    $(ls "$ZLIB"/*.c 2>/dev/null | wc -l) C source files"
    echo ""
    ls "$ZLIB"/*.c 2>/dev/null | xargs -n1 basename | sort | tr "\n" " "
    echo ""
else
    echo "Warning: zlib directory not found (may be in different location)"
fi

echo ""
echo "════════════════════════════════════════════════════════════════════════════════"
echo "  RESULT"
echo "════════════════════════════════════════════════════════════════════════════════"
echo ""
echo "  Passed: $PASS/4"
echo "  Failed: $FAIL/4"
echo ""
if [ $FAIL -eq 0 ]; then
    echo "  ✅ VERIFIED: Vulnerable code NOT present in Java source"
    echo "  CVE-2026-22184 does NOT affect this Java build."
    exit 0
else
    echo "  ❌ WARNING: Vulnerable patterns found - review needed"
    exit 1
fi
'

echo ""
echo "Source verification complete!"
