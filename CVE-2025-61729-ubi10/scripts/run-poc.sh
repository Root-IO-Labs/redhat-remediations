#!/usr/bin/env bash
set -euo pipefail

# CVE-2025-61729 Proof of Concept Test Runner for UBI 10
#
# This script runs the POC against two environments:
# 1. UBI 10 Unpatched - Base golang from repos
# 2. UBI 10 Patched - Golang with our CVE patch applied (rpms/ folder)
#
# Usage:
#   ./run-poc.sh [--all|--ubi10-unpatched|--ubi10-patched]
#   ./run-poc.sh --sans 10000  # Test with 10000 SANs

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CVE_DIR="$(dirname "$SCRIPT_DIR")"

cd "$CVE_DIR"

# Default settings
NUM_SANS="${NUM_SANS:-5000}"
RUN_UBI10_UNPATCHED=false
RUN_UBI10_PATCHED=false
RUN_ALL=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --all)
            RUN_ALL=true
            shift
            ;;
        --ubi10-unpatched|--unpatched)
            RUN_UBI10_UNPATCHED=true
            shift
            ;;
        --ubi10-patched|--patched)
            RUN_UBI10_PATCHED=true
            shift
            ;;
        --sans)
            NUM_SANS="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo ""
            echo "CVE-2025-61729 POC Test Runner for UBI 10"
            echo ""
            echo "Usage: $0 [options]"
            echo ""
            echo "Options:"
            echo "  --all              Run all tests"
            echo "  --ubi10-unpatched  Test UBI 10 base (vulnerable)"
            echo "  --ubi10-patched    Test UBI 10 with our patched RPMs"
            echo "  --sans <number>    Number of SANs to test with (default: 5000)"
            echo ""
            echo "Examples:"
            echo "  $0 --all"
            echo "  $0 --ubi10-patched"
            echo "  $0 --all --sans 10000"
            echo ""
            exit 1
            ;;
    esac
done

# If no specific test selected, run all
if [ "$RUN_ALL" = false ] && [ "$RUN_UBI10_UNPATCHED" = false ] && [ "$RUN_UBI10_PATCHED" = false ]; then
    RUN_ALL=true
fi

if [ "$RUN_ALL" = true ]; then
    RUN_UBI10_UNPATCHED=true
    RUN_UBI10_PATCHED=true
fi

echo "=============================================="
echo "CVE-2025-61729 POC Test Suite (UBI 10)"
echo "=============================================="
echo ""
echo "Configuration:"
echo "  Number of SANs: $NUM_SANS"
echo "  CVE Directory: $CVE_DIR"
echo ""

# Results tracking
declare -A RESULTS

#######################################
# Test 1: UBI 10 Unpatched (Base)
#######################################
if [ "$RUN_UBI10_UNPATCHED" = true ]; then
    echo "=============================================="
    echo "TEST 1: UBI 10 Unpatched (Base from repos)"
    echo "=============================================="
    echo ""

    echo "Building UBI 10 Unpatched POC container..."
    docker build -f dockerfiles/Dockerfile.ubi10-unpatched -t cve-2025-61729-poc-ubi10-unpatched . 2>&1 | tail -5

    echo ""
    echo "Running POC test..."
    echo "----------------------------------------------"
    if docker run --rm -e NUM_SANS="$NUM_SANS" cve-2025-61729-poc-ubi10-unpatched; then
        RESULTS["ubi10-unpatched"]="COMPLETED"
    else
        RESULTS["ubi10-unpatched"]="FAILED"
    fi
    echo "----------------------------------------------"
    echo ""
fi

#######################################
# Test 2: UBI 10 Patched (Our RPMs)
#######################################
if [ "$RUN_UBI10_PATCHED" = true ]; then
    echo "=============================================="
    echo "TEST 2: UBI 10 Patched (Custom RPMs)"
    echo "=============================================="
    echo ""

    # Check if patched RPMs exist in the rpms/ folder
    if [ ! -d "$CVE_DIR/rpms" ] || [ -z "$(ls -A $CVE_DIR/rpms/*.rpm 2>/dev/null)" ]; then
        echo "ERROR: Patched RPMs not found in $CVE_DIR/rpms/"
        echo ""
        echo "The rpms/ folder should contain the patched golang RPMs."
        echo "If missing, rebuild them from the project root:"
        echo "  cd $(dirname "$CVE_DIR")"
        echo "  ./docker-build.sh"
        echo "  ./docker-run.sh golang"
        echo "  cp out/10/RPMS/x86_64/golang*.rpm CVE-2025-61729/rpms/"
        echo "  cp out/10/RPMS/noarch/golang*.rpm CVE-2025-61729/rpms/"
        echo ""
        RESULTS["ubi10-patched"]="SKIPPED (no RPMs in rpms/)"
    else
        echo "Found patched RPMs:"
        ls -lh rpms/*.rpm

        echo ""
        echo "Building UBI 10 Patched POC container..."
        if docker build -f dockerfiles/Dockerfile.ubi10-patched -t cve-2025-61729-poc-ubi10-patched . 2>&1 | tail -10; then
            echo ""
            echo "Running POC test..."
            echo "----------------------------------------------"
            if docker run --rm -e NUM_SANS="$NUM_SANS" cve-2025-61729-poc-ubi10-patched; then
                RESULTS["ubi10-patched"]="COMPLETED"
            else
                RESULTS["ubi10-patched"]="FAILED"
            fi
            echo "----------------------------------------------"
        else
            echo "ERROR: Failed to build patched container"
            RESULTS["ubi10-patched"]="BUILD FAILED"
        fi
    fi
    echo ""
fi

#######################################
# Summary
#######################################
echo "=============================================="
echo "TEST SUMMARY"
echo "=============================================="
echo ""
echo "Test Results:"
for test in "${!RESULTS[@]}"; do
    printf "  %-20s %s\n" "$test:" "${RESULTS[$test]}"
done
echo ""
echo "=============================================="
echo ""
echo "Interpretation:"
echo "  - PATCHED: Error message is truncated (< 1000 chars)"
echo "  - VULNERABLE: Error message contains all SANs (very long)"
echo ""
echo "Expected Results:"
echo "  - UBI 10 Unpatched:  VULNERABLE (base from Red Hat repos)"
echo "  - UBI 10 Patched:    PATCHED (our fix applied)"
echo ""
echo "For detailed results, see: results/test-results.md"
echo ""
