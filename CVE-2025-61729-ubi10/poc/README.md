# CVE-2025-61729 Proof of Concept Test

## Overview

This Proof of Concept (POC) test demonstrates and verifies the fix for **CVE-2025-61729**, a resource exhaustion vulnerability in Go's `crypto/x509` package. The vulnerability allows malicious TLS certificates with many Subject Alternative Names (SANs) to cause excessive CPU usage and memory allocation through O(N²) string concatenation, leading to denial of service.

## Vulnerability Description

**CVE-2025-61729** is a resource exhaustion vulnerability where:
- **Attack Vector**: Malicious TLS certificate with thousands of SANs
- **Impact**: Excessive CPU usage (O(N²) complexity) and memory allocation (up to 319MB+ for 5000 SANs)
- **Attack Type**: Resource exhaustion via quadratic string concatenation
- **Severity**: Medium (CVSS TBD)
- **Affected Component**: `crypto/x509.HostnameError.Error()` method

### How the Attack Works

The vulnerability exists in the `HostnameError.Error()` method in `src/crypto/x509/verify.go`. When a certificate verification fails due to hostname mismatch, the error message is constructed by concatenating all SANs using the `+=` operator in a loop:

```go
// VULNERABLE CODE (before fix)
var valid string
for _, san := range c.IPAddresses {
    if len(valid) > 0 {
        valid += ", "  // O(N²) string concatenation!
    }
    valid += san.String()
}
```

**Problems**:
1. **O(N²) Complexity**: Each string concatenation creates a new string, copying all previous content
2. **No Limit**: There was no limit on how many SANs would be included in the error message
3. **Resource Exhaustion**: With thousands of SANs, this causes excessive CPU and memory usage

**Impact with 5000 SANs**:
- **Unpatched**: Error message = 60,286 bytes, Memory = 319 MB, Time = 43ms
- **Patched**: Error message = 73 bytes, Memory = 1.7 KB, Time = 49µs
- **Improvement**: ~875x faster, ~187,000x less memory

## POC Test Development

### Source of POC Information

The POC test and attack payload were developed based on the following sources:

#### 1. **Go Project Issue Tracker**
- **Issue #76445**: [crypto/x509: HostnameError.Error() uses O(N²) string concatenation](https://github.com/golang/go/issues/76445)
  - Initial bug report and discussion
  - Details on the O(N²) behavior and resource consumption
  - Community discussion of the fix approach
- **Issue #76461**: Related issue tracking the CVE assignment
- **Repository**: https://github.com/golang/go
- **Reference**: Go project issue tracker

#### 2. **Upstream Code Review (CL)**
- **CL 725800**: [crypto/x509: prevent HostnameError.Error() from consuming excessive resource](https://go-review.googlesource.com/c/go/+/725800)
  - Main fix implementation
  - Code review discussions and approvals
  - Test cases added in `verify_test.go`
- **Change-Id**: `I6343776ec3289577abc76dad71766c491c1a7c81`
- **Reviewers**: Neal Patel, Damien Neil, Roland Shoemaker, Mark Freeman, Dmitri Shuralyov
- **Reference**: Go code review system (Gerrit)

#### 3. **Security Reporter**
- **Reporter**: Philippe Antoine (Catena cyber)
- **Report Method**: Security disclosure to Go security team
- **Reference**: Patch commit message and security advisories

#### 4. **Patch Author**
- **Author**: Nicholas S. Husin (nsh@golang.org)
- **Date**: November 24, 2025
- **Commit**: `f7bce4bd6f7b13de8d9f06f7f262e3b60381e7e9`
- **Reference**: Go repository commit history

#### 5. **Security Advisories**
- **Go Security Advisory**: GO-2025-4155
  - Official Go security advisory
  - Lists affected versions and fix information
- **Ubuntu Security**: [CVE-2025-61729 Advisory](https://ubuntu.com/security/CVE-2025-61729)
  - Ubuntu's security notice with CVSS scoring
  - References to upstream CL and issues
- **SUSE Security**: [CVE-2025-61729](https://www.suse.com/security/cve/CVE-2025-61729.html)
  - SUSE security advisory
  - Package versions and fix information
- **Red Hat**: Security advisories and patch information
- **Reference**: Vendor security advisory databases

#### 6. **NVD (National Vulnerability Database)**
- **NVD Entry**: [CVE-2025-61729](https://nvd.nist.gov/vuln/detail/CVE-2025-61729)
- **CVSS Score**: TBD (Medium severity)
- **Content**: Official CVE description, references to upstream repos, issue trackers, and patch links
- **Reference**: NIST National Vulnerability Database

#### 7. **Upstream Test Suite**
- **Location**: Go repository `src/crypto/x509/verify_test.go`
- **Test Functions**: 
  - `TestTooManyDNS`: Tests certificate with 200 DNS SANs
  - `TestTooManyIPs`: Tests certificate with 150 IP SANs
  - `generatePEMCertWithRepeatSAN`: Helper function to generate test certificates
- **Content**: Test cases added in CL 725800 to verify the fix
- **Reference**: Upstream test code in Go repository

#### 8. **Technical Analysis**
- **File**: `src/crypto/x509/verify.go`
- **Method**: `HostnameError.Error()`
- **Vulnerable Pattern**: String concatenation in loop (`valid += ...`)
- **Fix Pattern**: `strings.Builder` with early return for ≥100 SANs
- **Reference**: Go standard library source code

### Origin and Rationale

This POC test was developed to:

1. **Demonstrate the vulnerability**: Show how a certificate with many SANs can cause excessive resource consumption
2. **Verify the fix**: Confirm that the patched Go library properly mitigates the attack
3. **Measure impact**: Quantify the performance difference between patched and unpatched versions
4. **Test both attack vectors**: Verify both DNS SANs and IP SANs are protected

### Test Design

The POC test (`main.go`) implements two test cases:

#### Test 1: Certificate with Many DNS SANs
- **Purpose**: Demonstrate vulnerability with DNS Subject Alternative Names
- **Method**: 
  - Generates a self-signed certificate with N DNS SANs (default: 5000)
  - Attempts to verify against a non-matching hostname
  - Triggers `HostnameError.Error()` to construct error message
- **Measurements**:
  - Time elapsed
  - Memory allocated
  - Error message length
- **Expected Behavior**:
  - **Unpatched**: Error message contains all SANs (108,939 bytes for 5000 SANs)
  - **Patched**: Error message truncated (74 bytes, shows count instead)

#### Test 2: Certificate with Many IP SANs
- **Purpose**: Demonstrate vulnerability with IP Address Subject Alternative Names
- **Method**:
  - Generates a self-signed certificate with N IP SANs (default: 5000)
  - Attempts to verify against a non-matching IP address
  - Triggers `HostnameError.Error()` to construct error message
- **Measurements**:
  - Time elapsed
  - Memory allocated
  - Error message length
- **Expected Behavior**:
  - **Unpatched**: Error message contains all IPs (60,286 bytes for 5000 IPs), high memory usage (319 MB)
  - **Patched**: Error message truncated (73 bytes), minimal memory (1.7 KB)

### Attack Payload

The POC generates certificates with configurable numbers of SANs:

**DNS SANs**:
```go
dnsNames := make([]string, count)
for i := 0; i < count; i++ {
    dnsNames[i] = fmt.Sprintf("host%d.example.com", i)
}
```

**IP SANs**:
```go
ipAddresses := make([]net.IP, count)
for i := 0; i < count; i++ {
    ipAddresses[i] = net.IPv4(10, byte((i/65536)%256), byte((i/256)%256), byte(i%256))
}
```

**Default Test**: 5000 SANs (configurable via `NUM_SANS` environment variable)

**Resource Consumption** (Unpatched, 5000 SANs):
- DNS SANs: ~949 KB memory, 108,939 byte error message
- IP SANs: ~319 MB memory, 60,286 byte error message, 43ms execution time

## The Fix

### Upstream Implementation

The fix was implemented in **Go 1.24.x and 1.25.x** via Code Review:

**Reference**: [Go CL 725800](https://go-review.googlesource.com/c/go/+/725800)

### Key Components

1. **Use `strings.Builder`**:
   - Replaces string concatenation (`valid += ...`) with `strings.Builder`
   - Changes complexity from O(N²) to O(N)
   - More efficient memory allocation

2. **Limit Output to 100 Names**:
   - When certificate has ≥100 SANs, returns summary message instead of listing all
   - Format: `"x509: certificate is valid for %d names, but none matched %s"`
   - Prevents unbounded error message growth

3. **Improved Error Messages**:
   - Shows count instead of all names when limit is reached
   - Maintains clarity while preventing resource exhaustion

### Fixed Code

```go
// FIXED CODE (after patch)
func (h HostnameError) Error() string {
    c := h.Certificate
    maxNamesIncluded := 100
    
    var valid strings.Builder
    if ip := net.ParseIP(h.Host); ip != nil {
        // IP validation
        if len(c.IPAddresses) >= maxNamesIncluded {
            return fmt.Sprintf("x509: certificate is valid for %d IP SANs, but none matched %s", 
                               len(c.IPAddresses), h.Host)
        }
        for _, san := range c.IPAddresses {
            if valid.Len() > 0 {
                valid.WriteString(", ")  // O(N) with strings.Builder
            }
            valid.WriteString(san.String())
        }
    } else {
        // DNS validation
        if len(c.DNSNames) >= maxNamesIncluded {
            return fmt.Sprintf("x509: certificate is valid for %d names, but none matched %s", 
                               len(c.DNSNames), h.Host)
        }
        valid.WriteString(strings.Join(c.DNSNames, ", "))
    }
    
    if valid.Len() == 0 {
        return "x509: certificate is not valid for any names, but wanted to match " + h.Host
    }
    return "x509: certificate is valid for " + valid.String() + ", not " + h.Host
}
```

### Our Patch

Our patch (`../patches/CVE-2025-61729.patch`) backports the fix from upstream Go to golang 1.25.3 for UBI 9, including:
- Core fix in `src/crypto/x509/verify.go`
- Test cases in `src/crypto/x509/verify_test.go`
- All related changes from CL 725800

**Patch Source**: Adapted from Go CL 725800 (commit `f7bce4bd6f7b13de8d9f06f7f262e3b60381e7e9`)

## References

### Primary Sources

1. **Upstream Fix**:
   - Go CL: https://go-review.googlesource.com/c/go/+/725800
   - Change-Id: `I6343776ec3289577abc76dad71766c491c1a7c81`
   - Commit: `f7bce4bd6f7b13de8d9f06f7f262e3b60381e7e9`
   - Author: Nicholas S. Husin (nsh@golang.org)
   - Date: November 24, 2025

2. **CVE Information**:
   - CVE ID: CVE-2025-61729
   - NVD Entry: https://nvd.nist.gov/vuln/detail/CVE-2025-61729
   - CVSS Score: TBD (Medium severity)
   - Vulnerability Type: Resource Exhaustion / DoS
   - Attack Pattern: O(N²) string concatenation

3. **Go Project Issues**:
   - Issue #76445: https://github.com/golang/go/issues/76445
   - Issue #76461: Related CVE tracking issue
   - Repository: https://github.com/golang/go

4. **Security Advisories**:
   - Go Security Advisory: GO-2025-4155
   - Ubuntu: https://ubuntu.com/security/CVE-2025-61729
   - SUSE: https://www.suse.com/security/cve/CVE-2025-61729.html
   - Red Hat: Security advisories and patch information

5. **Security Reporter**:
   - Reporter: Philippe Antoine (Catena cyber)
   - Disclosure: Security disclosure to Go security team

6. **Related Documentation**:
   - Go crypto/x509 Package: https://pkg.go.dev/crypto/x509
   - strings.Builder Documentation: https://pkg.go.dev/strings#Builder
   - Upstream Test Suite: `src/crypto/x509/verify_test.go`

### Technical References

1. **Vulnerable Code Location**:
   - File: `src/crypto/x509/verify.go`
   - Method: `HostnameError.Error()`
   - Lines: ~110-120 (before fix)

2. **Fix Implementation**:
   - File: `src/crypto/x509/verify.go`
   - Method: `HostnameError.Error()`
   - Changes: Use `strings.Builder`, add 100-name limit

3. **Test Implementation**:
   - Based on upstream test cases from CL 725800
   - Generates certificates with configurable SAN counts
   - Measures time, memory, and error message length
   - Uses Go's `runtime.MemStats` for memory measurement

## Running the POC

### Prerequisites

- Docker (for containerized testing)
- Go 1.21+ (for building the POC)
- Access to patched/unpatched golang RPMs

### Quick Start

```bash
# From the project root
cd CVE-2025-61729-ubi9

# Run POC test script
./scripts/run-poc.sh --all

# Run individual tests
./scripts/run-poc.sh --ubi9-unpatched   # Test UBI 9 base (vulnerable)
./scripts/run-poc.sh --ubi9-patched     # Test UBI 9 with patch

# Custom number of SANs
NUM_SANS=10000 ./scripts/run-poc.sh --all

# Or test manually
cd poc
go run main.go
NUM_SANS=10000 go run main.go
```

### Expected Results

**Patched Version**:
```
Go Version: go1.25.3 (Red Hat 1.25.3-1.el9)
Testing with 5000 SANs

--- Test 1: Certificate with many DNS SANs ---
Generated certificate with 5000 DNS names
Time elapsed: 1.230181ms
Memory allocated: 721,872 bytes
Error message length: 74 (PATCHED - message truncated)
RESULT: PATCHED ✓

--- Test 2: Certificate with many IP SANs ---
Generated certificate with 5000 IP addresses
Time elapsed: 49.35µs
Memory allocated: 1,728 bytes
Error message length: 73 (PATCHED - message truncated)
RESULT: PATCHED ✓
```

**Unpatched Version**:
```
Go Version: go1.25.3 (Red Hat 1.25.3-1.el9_7)
Testing with 5000 SANs

--- Test 1: Certificate with many DNS SANs ---
Generated certificate with 5000 DNS names
Time elapsed: 1.372867ms
Memory allocated: 949,544 bytes
Error message length: 108,939 (VULNERABLE - all SANs included)
RESULT: VULNERABLE ✗

--- Test 2: Certificate with many IP SANs ---
Generated certificate with 5000 IP addresses
Time elapsed: 43.185679ms
Memory allocated: 319,021,416 bytes (~319 MB)
Error message length: 60,286 (VULNERABLE - all IPs included)
RESULT: VULNERABLE ✗
```

## Verification

The POC verifies the fix by checking:

1. ✅ **Error Message Length**: Truncated to < 1000 bytes when ≥100 SANs
   - Patched: ~73-74 bytes (summary message)
   - Unpatched: 60,000+ bytes (all SANs listed)

2. ✅ **Memory Usage**: Significantly reduced memory allocation
   - IP SANs: ~187,000x reduction (319 MB → 1.7 KB)
   - DNS SANs: ~1.3x reduction (949 KB → 721 KB)

3. ✅ **Execution Time**: Faster error message construction
   - IP SANs: ~875x faster (43ms → 49µs)
   - DNS SANs: ~1.1x faster (1.37ms → 1.23ms)

4. ✅ **Normal Operation**: Certificate validation still works correctly
   - No regression in standard functionality
   - Error messages remain informative

## Performance Comparison

| Metric | Unpatched | Patched | Improvement |
|--------|-----------|---------|-------------|
| IP SANs Time | 43.19ms | 49.35µs | **~875x faster** |
| IP SANs Memory | 319 MB | 1.7 KB | **~187,000x less** |
| IP SANs Error Msg | 60,286 bytes | 73 bytes | **~825x smaller** |
| DNS SANs Time | 1.37ms | 1.23ms | **~1.1x faster** |
| DNS SANs Memory | 949 KB | 721 KB | **~1.3x less** |
| DNS SANs Error Msg | 108,939 bytes | 74 bytes | **~1,472x smaller** |

## Conclusion

This POC test demonstrates that:

1. The vulnerability exists and can be exploited with certificates containing many SANs
2. The fix effectively mitigates the attack through `strings.Builder` and output limiting
3. The patched library maintains normal functionality
4. Significant performance improvements are achieved (especially for IP SANs)

The test serves as both a **demonstration** of the vulnerability and a **verification** that the fix is working correctly, with measurable improvements in both time and memory usage.

---

**Last Updated**: January 2026  
**Test File**: `main.go`  
**Related Files**: `../patches/CVE-2025-61729.patch`, `../results/test-results.md`
