#!/bin/bash
#
# CVE-2026-22184 Test Runner
# Tests Java 17 OpenJDK for zlib untgz buffer overflow vulnerability
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPORT_DIR="$(dirname "$SCRIPT_DIR")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
    echo "CVE-2026-22184 Test Runner - Java 17 OpenJDK"
    echo ""
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --all           Run all tests (default)"
    echo "  --java          Run Java tests only"
    echo "  --c-demo        Run C vulnerability demo only"
    echo "  --build         Build Docker test image"
    echo "  --docker        Run tests in Docker container"
    echo "  --help          Show this help"
    echo ""
}

run_java_test() {
    echo ""
    echo -e "${BLUE}════════════════════════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  Running Java Comprehensive Test${NC}"
    echo -e "${BLUE}════════════════════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    docker run --rm \
        -v "$REPORT_DIR/poc/java:/test:ro" \
        registry.access.redhat.com/ubi9/ubi \
        bash -c "
            dnf -y install java-17-openjdk-devel >/dev/null 2>&1
            cd /tmp
            cp /test/*.java .
            javac -encoding UTF-8 ComprehensiveZlibTest.java
            java ComprehensiveZlibTest
        "
}

run_c_demo() {
    echo ""
    echo -e "${BLUE}════════════════════════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  Running C Vulnerability Demo${NC}"
    echo -e "${BLUE}════════════════════════════════════════════════════════════════════════════════${NC}"
    echo ""
    
    docker run --rm \
        -v "$REPORT_DIR/poc/c:/test:ro" \
        registry.access.redhat.com/ubi9/ubi \
        bash -c "
            dnf -y install gcc >/dev/null 2>&1
            cd /tmp
            cp /test/*.c .
            gcc -fno-stack-protector -o vulnerable_demo vulnerable_untgz_demo.c
            timeout 10 ./vulnerable_demo || echo 'Demo completed (crash expected)'
        "
}

build_docker() {
    echo ""
    echo -e "${BLUE}Building Docker test image...${NC}"
    echo ""
    
    cd "$REPORT_DIR"
    docker build -f dockerfiles/Dockerfile.test -t cve-2026-22184-java17-test .
}

run_docker() {
    echo ""
    echo -e "${BLUE}Running tests in Docker container...${NC}"
    echo ""
    
    docker run --rm cve-2026-22184-java17-test
}

run_all() {
    echo ""
    echo "╔═══════════════════════════════════════════════════════════════════════════════╗"
    echo "║           CVE-2026-22184 Vulnerability Test Suite                             ║"
    echo "║           Java 17 OpenJDK on Red Hat UBI 9                                     ║"
    echo "╚═══════════════════════════════════════════════════════════════════════════════╝"
    echo ""
    
    run_java_test
    
    echo ""
    run_c_demo
    
    echo ""
    echo "╔═══════════════════════════════════════════════════════════════════════════════╗"
    echo "║                              TEST COMPLETE                                    ║"
    echo "╚═══════════════════════════════════════════════════════════════════════════════╝"
    echo ""
    echo -e "  ${GREEN}✅ Java tests: ALL PASSED${NC}"
    echo -e "  ${YELLOW}⚠️  C demo: Demonstrated vulnerability (crash expected)${NC}"
    echo ""
    echo "  CONCLUSION: Java is NOT affected by CVE-2026-22184"
    echo ""
}

# Main
case "${1:-}" in
    --java)
        run_java_test
        ;;
    --c-demo)
        run_c_demo
        ;;
    --build)
        build_docker
        ;;
    --docker)
        run_docker
        ;;
    --help|-h)
        usage
        ;;
    --all|*)
        run_all
        ;;
esac
