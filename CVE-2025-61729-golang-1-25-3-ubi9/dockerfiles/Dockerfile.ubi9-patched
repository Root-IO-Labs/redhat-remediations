# CVE-2025-61729 POC Test - UBI 9 (Patched with custom RPMs)
#
# This tests the golang package built with our CVE patch.
# The patched RPMs are included in the rpms/ directory.
#
# Build: docker build -f dockerfiles/Dockerfile.ubi9-patched -t cve-poc-ubi9-patched .
# Run:   docker run --rm -e NUM_SANS=5000 cve-poc-ubi9-patched

FROM registry.access.redhat.com/ubi9/ubi

LABEL description="CVE-2025-61729 POC - UBI 9 Patched"
LABEL cve="CVE-2025-61729"
LABEL target="UBI 9 Patched (Custom RPMs)"

# Install base dependencies
RUN dnf -y update && \
    dnf -y install findutils && \
    dnf -y clean all

# Copy the patched RPMs from the rpms/ directory
COPY rpms/ /tmp/rpms/

# Install the patched golang RPMs
RUN cd /tmp/rpms && \
    dnf -y install ./golang-1.25.3-*.x86_64.rpm \
                   ./golang-bin-1.25.3-*.x86_64.rpm \
                   ./golang-src-1.25.3-*.noarch.rpm || \
    (echo "Installing RPMs with --nodeps..." && \
     rpm -ivh --nodeps ./golang-1.25.3-*.x86_64.rpm \
                       ./golang-bin-1.25.3-*.x86_64.rpm \
                       ./golang-src-1.25.3-*.noarch.rpm) && \
    rm -rf /tmp/rpms

# Verify golang is installed
RUN go version

# Copy POC code
WORKDIR /poc
COPY poc/ .

# Build the POC
RUN go build -o cve-poc .

# Set default number of SANs for testing
ENV NUM_SANS=5000

CMD ["./cve-poc"]
