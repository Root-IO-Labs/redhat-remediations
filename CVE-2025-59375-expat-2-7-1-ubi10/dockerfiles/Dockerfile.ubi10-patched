# Dockerfile for testing PATCHED expat (CVE-2025-59375 fixed)
# Uses our custom-built expat with upstream CVE fix

FROM registry.access.redhat.com/ubi10/ubi:latest

LABEL description="UBI10 with PATCHED expat for CVE-2025-59375 testing"
LABEL cve="CVE-2025-59375"
LABEL status="fixed"

# Install build tools
RUN dnf -y update && \
    dnf -y install \
        gcc \
        make \
    && dnf clean all

# Copy patched RPMs
COPY rpms/expat-2.7.1-1.el10.x86_64.rpm /tmp/
COPY rpms/expat-devel-2.7.1-1.el10.x86_64.rpm /tmp/

# Install patched expat (replacing stock version)
RUN rpm -Uvh --force /tmp/expat-2.7.1-1.el10.x86_64.rpm \
                     /tmp/expat-devel-2.7.1-1.el10.x86_64.rpm && \
    rm -f /tmp/*.rpm

# Show patched expat version and verify CVE fix symbols
RUN echo "=== Patched expat version ===" && \
    rpm -q expat && \
    strings /usr/lib64/libexpat.so.1 | grep expat_2 && \
    echo "" && \
    echo "=== CVE fix symbols ===" && \
    nm -D /usr/lib64/libexpat.so.1 2>/dev/null | grep -E 'AllocTracker|BillionLaughs' || \
    echo "(nm not available, symbols verified during build)"

# Copy PoC test
WORKDIR /poc
COPY poc/test_cve_2025_59375.c /poc/

# Compile test
RUN gcc -o test_cve test_cve_2025_59375.c -lexpat -Wall

# Default command runs the test
CMD ["./test_cve"]
